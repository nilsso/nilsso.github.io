<!doctype html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/jpg" href="https://avatars1.githubusercontent.com/u/567181?s=60&v=4">
    <style>@import url("https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css");@import url("https://fonts.googleapis.com/css2?family=Merriweather&family=Roboto+Mono&display=swap");html,body{color:#35393e;font-family:"Merriweather",serif;line-height:1.8;font-size:18px}@media (max-width: 520px){html,body{font-size:16px}}@media (max-width: 460px){html,body{font-size:14px}}body{max-width:8in;margin:2rem auto;padding:0 1rem}p{margin:1rem 0}code{font-family:"Roboto Mono",monospace}fg{display:inline-block;text-indent:0px;line-height:normal;-webkit-text-emphasis:none;text-align:center;line-height:1}fg:before{content:attr(t);display:block;font-size:50%;line-height:1.5}cb1{color:#4080bf}cb2{color:#bf8040}cb3{color:#bf4040}cb4{color:#bfbf40}cb5{color:#4040bf}a{color:#4080bf;text-decoration:none}a:hover,a:focus{color:#bf8040}h1,h2,h3,h4,h5,h6{font-family:"Roboto Mono",monospace;line-height:1.2}h1,h2,h3{margin:2rem 0}h4,h5,h6{margin:1.5rem 0}h1{font-size:200%}h2{font-size:180%}h3{font-size:160%}h4,h5,h6{font-size:140%}hr{background:#35393e;border:0;height:1px;margin:2.5rem 0}img{width:100%}pre{padding:1rem;border-radius:3px}table{margin:auto;border-spacing:0}td,th{border-left:1px #000 solid;padding:.25em .75em}td:first-child,th:first-child{border-left:0}th{font-weight:bold}.center,.cg{display:block;text-align:center}.gray,.cg{color:gray}blockquote,.box{margin:1rem 0;padding-left:1rem;border-left:3px solid #8c99a6}.box.theorem{border-color:#4080bf}.box .proposition{border-color:#bf8040}.box.lemma{border-color:#bf4040}.box.corollary{border-color:#bfbf40}.box.definition{border-color:#4040bf}.nav{margin:2.5rem 0}.nav .nav-link{display:inline;padding:0 .5em}.nav .nav-item:first-of-type a{padding-left:0}.nav .dropdown-menu{min-width:0;margin:0;padding:.25rem 0}.nav .dropdown-menu .dropdown-item{padding:.25rem .5rem;color:#4080bf}#toc{margin-bottom:0}.listing{margin-bottom:3rem}.listing .listing-header,.listing .listing-content{padding:0}.listing-summary{color:#8c99a6}.listing-summary *{font-size:100%}.listing-summary h1,.listing-summary h2,.listing-summary h3 h4,.listing-summary h5,.listing-summary h6{margin:1rem 0}.listing-info{font-size:90%}.listing-info .listing-categories,.listing-info .listing-tags{list-style-type:none;padding:0}.listing-info ul li,.listing-info ul a{color:#8c99a6}.listing-info ul li{display:inline;margin-right:1rem}#katex-preamble{display:none}.katex-display{overflow-x:auto;overflow-y:hidden}#whitespace{height:50vh}</style>
    
    
    
    
    <script
        src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"
    ></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"
    ></script>
    <script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"
    ></script>
</head>
<body>
    
    
<ul class="nav">
    
    <li class="nav-item">
        <a class="nav-link" href=https:&#x2F;&#x2F;github.com&#x2F;nilsso>
            github
        </a>/
    </li>

    
    <li class="nav-item">
        <a class="nav-link" href=&#x2F;>
            home
        </a>/
    </li>

    
    <li class="nav-item">
        <a class="nav-link" href=&#x2F;projects>
            projects
        </a>/
    </li>

    <li class="nav-item dropdown">
        <a
            class="nav-link dropdown-toggle"
            data-toggle="dropdown"
            href="#"
            role="button"
            aria-haspopup="true"
            aria-expanded="false"
        >
            content
        </a>
        <div class="dropdown-menu">
            
            
            
            <a class="dropdown-item" href="https:&#x2F;&#x2F;nilsso.github.io&#x2F;pages&#x2F;lang&#x2F;">
                languages
            </a>
            
            
            <a class="dropdown-item" href="https:&#x2F;&#x2F;nilsso.github.io&#x2F;pages&#x2F;programming&#x2F;">
                programming
            </a>
            
            
            <a class="dropdown-item" href="https:&#x2F;&#x2F;nilsso.github.io&#x2F;pages&#x2F;music&#x2F;">
                music
            </a>
            
            
            <a class="dropdown-item" href="https:&#x2F;&#x2F;nilsso.github.io&#x2F;pages&#x2F;games&#x2F;">
                games
            </a>
            
            
            <a class="dropdown-item" href="https:&#x2F;&#x2F;nilsso.github.io&#x2F;pages&#x2F;math&#x2F;">
                math
            </a>
            
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/tags">tags</a>
        </div>
    </li>
</ul>

    
    <hr>
    <content>
        
        
        
        <h1>Pyright and Pylama for neovim Python development</h1>
        
        <h2 id="switching-to-pyright">Switching to <code>pyright</code> ðŸª¨</h2>
<p>It turned out that <code>pylsp</code> wasn't all that I thought it was, and I've switch to Microsoft's LSP,
<code>pyright</code>. It's job is to do, in addition to a limited amount of linting (which I'll
probably turn off), the static type-checking that I was using <code>mypy</code> for, except even better:
finally <code>match</code> statement support! This left me to re-include <code>null-ls</code> for formatting with <code>black</code>
and <code>isort</code>, and diagnostics with <code>pylama</code>. But there were a few problems.</p>
<span id="continue-reading"></span><h2 id="fixing-null-ls-and-pylama">Fixing <code>null-ls</code> and <code>pylama</code> ðŸ¦™</h2>
<p>Firstly, the problem with <code>pylama</code> was that it only looks for a configuration file
<kbd>pylama.ini</kbd> within the current working directory (cwd), or else a user configuration file
<kbd>~/.pylama.ini</kbd>. I have a feeling this does the job for many IDE whose linting program
command runners always start at the project root, but the problem for me was two-fold:
I'm not using an IDE and the working directory is a subfolder where the file I'm working on is;
and <code>null-ls</code> seems to have its own thoughts on where to place the root/cwd.</p>
<p>To fix <code>pylama</code>, <a href="https://github.com/nilsso/pylama">I forked it</a> and changed how it looks for configuration files to having it traverse
up the <code>cwd</code> parent tree until it reaches <code>~</code>, looking for any config file along the way. I might
want to change this to have it in general stop at the base of the nearest module, but then it
wouldn't work for this particular project.</p>
<pre data-lang="diff" class="language-diff "><code class="language-diff" data-lang="diff">diff --git a&#x2F;pylama&#x2F;config.py b&#x2F;pylama&#x2F;config.py
index f946619..08b2a29 100644
--- a&#x2F;pylama&#x2F;config.py
+++ b&#x2F;pylama&#x2F;config.py
@@ -16,7 +16,8 @@
 DEFAULT_LINTERS = &quot;pycodestyle&quot;, &quot;pyflakes&quot;, &quot;mccabe&quot;
 
 CURDIR = Path.cwd()
-HOMECFG = Path.home() &#x2F; &quot;.pylama.ini&quot;
+HOMEDIR = Path.home()
+HOMECFG = HOMEDIR &#x2F; &quot;.pylama.ini&quot;
 CONFIG_FILES = &quot;pylama.ini&quot;, &quot;setup.cfg&quot;, &quot;tox.ini&quot;, &quot;pytest.ini&quot;
 
 # Setup a logger
@@ -62,10 +63,13 @@ def get_default_config_file(rootdir: Path = None) -&gt; Optional[str]:
     if rootdir is None:
         return DEFAULT_CONFIG_FILE
 
-    for filename in CONFIG_FILES:
-        path = rootdir &#x2F; filename
-        if path.is_file() and os.access(path, os.R_OK):
-            return path.as_posix()
+    while HOMEDIR in rootdir.parents:
+        for filename in CONFIG_FILES:
+            path = rootdir &#x2F; filename
+            if path.is_file() and os.access(path, os.R_OK):
+                return path.as_posix()
+        rootdir = rootdir.parent
+
 
     return None
</code></pre>
<p>Running <code>pylama</code> from the terminal while in a subdirectory now finds the project config, hooray!
But it didn't work within <code>nvim</code>; the problem was that <code>null-ls</code> gives its sources a particular root
directory, and in this case it was giving the repository directory <kbd>project</kbd>, and
not the path of the current working directory, nor the Python project <kbd>project/python</kbd>.
I haven't figured out where exactly it's choosing to do this, or why, but it's probably to do with
the git root. To fix this we thankfully don't need to go forking <code>null-ls</code> and changing things, but
instead provide an override to <code>cwd</code> for the <code>pylama</code> source in our <code>null-ls</code> config, and the
simplest is just to provide the neovim evenloop cwd.</p>
<pre data-lang="lua" class="language-lua "><code class="language-lua" data-lang="lua">local null_ls = require(&quot;null-ls&quot;)
local diagnostics = null_ls.builtins.diagnostics
local formatting = null_ls.builtins.formatting

null_ls.setup({
    sources = {
        -- Python
        diagnostics.pylama.with({
            -- NOTE: for some reason pylama wants to start at the repository root?
            -- this means it&#x27;ll miss a pylama.ini in a nested directory
            -- e.g. project&#x2F;python&#x2F;pylama.ini
            cwd = vim.loop.cwd,
        }),
        formatting.black,
        formatting.isort,
    },
})
</code></pre>
<p>And now everything works just the way I've wanted it to!</p>

        <div id=whitespace></div>
        
    </content>
</body>
</html>
